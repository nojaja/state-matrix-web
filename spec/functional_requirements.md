# 状態整理マトリクス Web アプリ機能要件定義書

- 作成日: 2025-11-21
- 対象システム: state-matrix-web
- 参照資料: `spec/ER.md`

## 1. はじめに

本書は、複数部署・複数担当者の暗黙知を集約し、状態整理マトリクス (アクション×IN/OUT マトリクス) を Web 上で構築・分析するシステムの機能要件を定義する。状態は入力時に明示せず、蓄積されたアクションの IN/OUT から状態遷移図を後段で導出できることを基本思想とする。

## 2. 背景と目的

- 個々のユーザーは自身が関与する業務しか把握しておらず、全体像を俯瞰できる人材が存在しない。
- 各ユーザーが知っているアクション(=業務トリガー)と IN/OUT を入力し、集約することで全社的な状態整理マトリクスを生成したい。
- 過去案件(Case*)と型マスタ(*Types)の紐付けを通じて、未定義の業務型・成果物型を発見し、継続的にマスタを拡張する分析サイクルを確立したい。
- ユーザー自身が気付かない複数作業を洗い出し、入力後に分析者が分割・再分類できる柔軟性が必要である。

## 3. 想定ユーザーロール

| ロール | 主な責務 |
| --- | --- |
| Contributor (一般ユーザー) | 自身の案件・業務アクションを登録し、IN/OUT 情報を入力する |
| Analyst / PMO | 収集済みデータを分析し、未定義型の洗い出し・細分化・状態遷移図生成を行う |
| Administrator | カテゴリ/型マスタやユーザー、権限の維持管理を行う |

## 4. スコープ

### 4.1 In Scope

- Web UI を通じた案件、業務型、アクショントリガー、成果物データの登録・参照
- IN/OUT 観点でのマトリクス表示と編集
- 型マスタと案件実績のギャップ検出・追加導線
- 状態遷移図生成のためのエクスポート (データ提供)
- 監査ログ、タイムスタンプ、最終更新者の自動記録

### 4.2 Out of Scope

- 実際の状態遷移図レンダリング UI (外部ツール連携を想定)
- ファイルストレージ管理 (成果物ファイル本体の保管は別サービスを想定し、メタ情報のみ保持)
- 認証基盤の実装 (既存 SSO 連携を前提とし、本書では機能要件の抽象化に留める)

## 5. 業務フロー概要

1. Contributor が案件 (Case) を登録し、関与する JobTypes (業務型) を紐付ける。
2. 各 JobType に対して実行した ActionTriggerTypes を選択／新規登録し、IN 情報 (前提データ、既存成果物など) と OUT 情報 (生成成果物、決定事項) を記録する。
3. 成果物 (ArtifactTypes / CaseArtifacts) を紐付け、CRUD 種別や因果関係 (CausalRelationsTypes / CaseCausalRelations) を登録する。
4. Analyst は Case* と *Types の突合結果から、未使用／未定義の業務・成果物・因果パターンを検出し、必要に応じて型マスタへ昇格させる。
5. 集約したデータをもとに状態遷移図や WBS、役割分担表を外部出力する。
6. ユーザー特性に応じて以下 2 つの編集パターンを併用可能とし、`spec/user_operation_sequence.puml` でシーケンスを定義する。
	- **パターン1 (全体把握ユーザー)**: `*Types` を直接編集し、既存型の名寄せ(merge)やカテゴリ調整を行う。
	- **パターン2 (部分専門ユーザー)**: `Case*` から入力し、未定義 `*Types` をドラフト登録しつつ、投入後に CaseActionTriggers を細分化する。

## 6. データモデル要約

| エンティティ | 役割 (ER 参照) |
| --- | --- |
| Users | ユーザー情報。各 Case/Case* の所有者/更新者を保持 |
| CategoryMaster | 階層カテゴリ。Job/Action/Artifact 型を最下層カテゴリと紐付ける |
| JobTypes | 業務型マスタ。状態整理マトリクスの行基準になる業務単位 |
| ActionTriggerTypes | アクショントリガー型。IN/OUT の記録単位 |
| ArtifactTypes | 成果物型。OUT の標準化、再利用の単位 |
| CausalRelationsTypes | ActionTriggerType と ArtifactType の CRUD 関係テンプレート |
| Cases | 案件単位の実績ヘッダ |
| CaseJobTypes | 案件内で担当した業務型の実績 |
| CaseActionTriggers | 案件内で実行済みのアクショントリガー実績、実担当者・タイミングを保持 |
| CaseArtifacts | 案件内成果物実績。成果物ファイル名や備考を保持 |
| CaseCausalRelations | 案件内での業務→成果物 CRUD 連携実績 |

## 7. 機能要件

### F1. 認証・ユーザー管理
- 既存 SSO と連携し、ユーザー属性 (氏名・メール) を `Users` に同期する。
- ロール (Contributor/Analyst/Admin) に応じて画面・操作権限を制御する。

### F2. カテゴリ・型マスタ管理
- `CategoryMaster` の階層編集 (追加/改名/移動) とパンくず表示を提供する。
- Job/ActionTrigger/Artifact 各型をカテゴリと紐付けて登録・編集できる UI を提供する。
- Analyst は案件実績で発見された未登録型をドラフト状態で追加し、承認後に正式マスタへ昇格させる。
- 直接 `*Types` を操作するユーザー向けに、複数型を選択して名寄せ (merge) し、参照先を統合する機能を提供する。
- `*Types` の削除時には参照している `Case*` データの影響範囲を提示し、リネーム/マージ/論理削除の選択肢を提示する。

### F3. 案件 (Case) 管理
- 案件基本情報 (`Cases`) の CRUD と、Owner の自動設定/変更履歴を持つ。
- 案件に複数の JobTypes を `CaseJobTypes` 経由で紐付け、メモ/備考を残せる。

### F4. アクショントリガー入力 (IN/OUT マトリクス編集)
- ユーザーは `CaseJobTypes` 配下で ActionTrigger を選択 or 新規登録し、Describe/Actor/Timing/TimingDetail を入力する。
- IN 情報: 使用した既存成果物・資料・前提条件を Artifact 参照またはフリーテキストで記録できる。
- OUT 情報: 生成/更新した成果物を `CaseArtifacts` として登録し、CRUD 種別・備考を設定する。
- マトリクス UI 上で行 = ActionTrigger、列 = IN/OUT/Actor/Timing を表示し、行追加/複製/分割操作をサポートする。
- `Case*` を軸に入力するユーザー向けに、CaseActionTriggers の分割ウィザードを提供し、IN/OUT や Actor の差異を根拠として複数作業へ切り分けられるようにする。

### F5. 成成果物実績管理
- `CaseArtifacts` にファイル名、成果物種別、関連資料リンクを登録する。
- 既存 ArtifactTypes から選択 or 新規ドラフト作成が可能。
- 同一成果物を複数 ActionTrigger の IN として再利用できるよう、参照整合性を確保する。

### F6. 因果関係登録・テンプレート適用
- `CaseCausalRelations` を UI 上でドラッグ&ドロップ等により作成し、ActionTrigger ↔ Artifact の CRUD 関係を紐付ける。
- 既存 `CausalRelationsTypes` をテンプレートとして適用し、一括登録・差分修正を可能にする。

### F7. ギャップ分析・未定義型検出
- 案件実績に登場する ActionTrigger / Artifact がマスタ未登録の場合に、アラートと登録導線を表示する。
- `*Types` と `Case*` の突合結果から「未使用の型」「案件固有の新規候補」「過去 90 日で未入力の型」をレポートする。
- Analyst はギャップ一覧から型を採用/破棄/保留に分類でき、決定内容を履歴として保持する。

### F8. 作業細分化・複数作業検知
- 同一ユーザーの ActionTrigger 実績を解析し、IN/OUT の組み合わせから「複数作業の可能性」を提示する (例: OUT が 2 つ以上かつ Actor または Timing が異なる場合に分割候補として提示)。
- Analyst または Case 登録者は、ケース詳細画面から候補を承認すると ActionTrigger を複製し、IN/OUT を再配分できる。

### F9. 可視化・エクスポート
- IN/OUT マトリクスを CSV/JSON でエクスポートし、外部の状態遷移図ツールへ連携できる。
- ActionTrigger → Artifact の連鎖をグラフ形式でプレビューし、状態候補 (例: OUT が次アクションの IN になる直前/直後状態) を導出する API を提供する。

### F10. コラボレーションと通知
- 同一案件に複数ユーザーが同時編集した際の競合検知・解決 (最終更新者・差分表示) を提供する。
- 変更が発生した JobType/ActionTrigger に関与するユーザーへ通知を送付できる購読機能を提供する。

### F11. 監査・履歴
- すべての CRUD 操作で `CreateTimestamp`/`LastUpdatedBy` を自動更新し、監査ログとして追跡可能にする。
- 主要マスタ・案件データはバージョン履歴を保持し、過去状態へロールバックできる。

## 8. 業務ルール・制約

1. 状態は入力 UI では扱わず、ActionTrigger の連鎖と成果物の受け渡しから導出する。
2. 1 つの ActionTrigger には複数の IN / OUT を設定可能とし、Actor や Timing を補助情報として記録する。
3. CRUD 種別は C (新規生成) / R (参照) / U (更新) / D (廃棄) を基本とし、任意のマッピングを `CausalRelationsTypes` で保持する。
4. 未定義型を案件入力時に登録した場合は「ドラフト」ステータスとなり、Analyst 承認後に他案件でも選択可能になる。
5. 成果物ファイルは別ストレージを想定し、本システムではメタ情報 (ファイル名、リンク、バージョン) のみ保持する。

## 9. 成功指標 (例)

- 主要部門の 80% が 3 ヶ月以内に少なくとも 1 案件を登録していること。
- 1 案件あたり平均 5 件以上の ActionTrigger が入力され、IN/OUT 情報が欠落していない割合が 90%以上であること。
- ギャップ分析により四半期ごとに新規 `*Types` が追加される率が 5% 以上であること。

## 10. 操作パターン要件

| パターン | 対象ユーザー | 主な操作 | 必須機能 |
| --- | --- | --- | --- |
| パターン1: 全体把握ユーザー | PMO / 業務横断担当 | `*Types` の直接登録/更新/削除、型の名寄せ、カテゴリ調整 | F2, F6, F7 |
| パターン2: 部分専門ユーザー | 各部署担当者 | `Case*` の登録、未定義 `*Types` のドラフト投入、CaseActionTriggers の分割 | F3, F4, F5, F8 |

- 各パターンの操作フローは `spec/user_operation_sequence.puml` のシーケンス図で定義し、UI 設計時の参照とする。
- いずれのパターンでも同一データ整合性ルール (監査ログ、参照制約) を遵守すること。

---
本書に記載されていない詳細 UI や技術仕様は別途設計ドキュメントで定義する。
